---
title: "Large datasets"
author: "Anonymous"
date: "2025-03-06"
output: html_document
bibliography: references.bib
  nocite: |
    @wickham2023r, @nichols
---

## Initialisation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#rm(list = ls())
library(Rcompadre)
library(tidyverse)
library(here)
library(phytools)
library(taxize)
library(Rage)
library(popbio)
library(svglite)
library(ggbeeswarm)
source(here("Functions.R"))
```

# introduction

# Compadre

## Acessing Data

```{r}
class <- "Aves"
ClassName <- paste(class, "class")
Comadre <- cdb_fetch("comadre")
ComSub <- subset(Comadre,
                   Class == class & #
                   MatrixTreatment == "Unmanipulated" &
                   MatrixCaptivity == "W")
```

## Manipulation

```{r}
ComFlag <- cdb_flag(ComSub)
ComSubFlag <- subset(ComFlag,
                      check_NA_A == FALSE &
                      check_ergodic == TRUE)
```

## Data

### Histograms

```{r warning=FALSE, message=FALSE}
ComSubFlag$lambda <- unlist(lapply(matA(ComSubFlag), 
                                   popbio::lambda))

ComSubFlag$generation_time <- unlist(lapply(matA(ComSubFlag), 
                                   popbio::generation.time))
GVG <- as_data_frame(ComSubFlag) %>%
  select(lambda, generation_time) %>% 
  mutate(across(everything(), ~ na_if(., Inf))) %>% 
  mutate(across(everything(), ~ na_if(., -Inf))) %>%
  drop_na()

#Examine the distribution of population growth rates:
GrowthHist <- histogram(GVG, GVG$lambda,
                        "Population Growth Rate(位)", 
                        paste("Histogram of Growth Rate Within the ", ClassName)
                        , 0.2, TRUE)

GenHist <- histogram(GVG, GVG$generation_time,
                        "Generation Time (years)", 
                        paste("Histogram of Generation Time Within the ", ClassName)
                        , 1, FALSE)



GrowthHist
GenHist
```

## relationship

```{r warning=FALSE, message=FALSE}
GenVGrowth <- scatterplot(GVG, GVG$generation_time, 
                          "Generation Time (years)", 
                          GVG$lambda,
                          "Growth Rate (位)", 
                          paste("Generation time Vs Growth Rate in the ", ClassName)
                          , FALSE)

GenVGrowth
```

### Linear model

normal

```{r}
CGVG <- subset(GVG, generation_time < 50)

GVGMod <- lm(lambda ~ generation_time, GVG)
diagnostic_plots("GVGMod DP.svg", GVGMod)

CGVGMod <- lm(lambda ~ generation_time, CGVG)
diagnostic_plots("CGVGMod DP.svg", CGVGMod)
```

log transformed

```{r}
LGVGMod <- lm(log(lambda) ~ log(generation_time), GVG)
diagnostic_plots("LGVGMod DP.svg", LGVGMod)

LCGVGMod <- lm(log(lambda) ~ log(generation_time), CGVG)
diagnostic_plots("LCGVGMod DP.svg", LCGVGMod)
```

polynomial

```{r}
PGVGMod <- lm(lambda ~ generation_time + I(generation_time^2) + I(generation_time^3), GVG)
diagnostic_plots("PGVGMod DP.svg", PGVGMod)

PCGVGMod <- lm(lambda ~ generation_time + I(generation_time^2) + I(generation_time^3), CGVG)
diagnostic_plots("PCGVGMod DP.svg", PCGVGMod)
```

generalized

```{r}
GGVGMod <- glm(lambda ~ generation_time, GVG)
diagnostic_plots("GGVGMod DP.svg", GGVGMod)

GGVGMod <- glm(lambda ~ generation_time, CGVG)
diagnostic_plots("GCGVGMod DP.svg", GCGVGMod)
```

## Spearman's rank correlation coefficient

-   other things very much not working

-   so trying a non parametric method

-   meets the assumptions

    -   monotonic

    -   outlier doesn't matter as robust

    -   indepedent observations

```{r}
cor.test(GVG$lambda, GVG$generation_time, method = "spearman")
```

-   very significant

-   moderate positive correlation, but doesn't describe the data too well

### Plotting

```{r}
GenVGrowth2 <- scatterplot(GVG, GVG$generation_time, 
                          "Generation Time (years)", 
                          GVG$lambda,
                          "Growth Rate (位)", 
                          paste("Generation time Vs Growth Rate in the", ClassName)
                          , TRUE)
GenVGrowth2
```

## seperating duplicates?

```{r}
ComSingle <- ComSubFlag[which(
  duplicated(ComSubFlag$SpeciesAccepted)==FALSE),]
```

# IUCN RedList

## Acessing data

-   due to issues with data having to load from computer

```{r}
IUCN_data<- read.csv(here("IUCN_comadre_compadre.csv"))

ComIUCN <- ComSubFlag %>%
  left_join(x = ., y = IUCN_data, by = "SpeciesAccepted") %>% 
  mutate(IUCNstatus = case_when(
    IUCNstatus == "EN" ~ "Endangered",
    IUCNstatus == "VU" ~ "Vulnerable",
    IUCNstatus == "NT" ~ "Near Threatened",
    IUCNstatus == "LC" ~ "Least Concern",
    is.na(IUCNstatus) == TRUE ~ "Not Assessed"),
    IUCNstatus = factor(IUCNstatus, 
                        levels = c("Endangered","Vulnerable",
                                   "Near Threatened","Least Concern",
                                   "Not Assessed")))

ComIUCN <- as.data.frame(ComIUCN)

ComIUCN$iucn_colour <- NA
ComIUCN$iucn_colour[which(ComIUCN$IUCNstatus == "Endangered")] <- "Orange" 
ComIUCN$iucn_colour[which(ComIUCN$IUCNstatus == "Vulnerable")] <- "Yellow"
ComIUCN$iucn_colour[which(ComIUCN$IUCNstatus == "Near Threatened")] <- "Dark green"
ComIUCN$iucn_colour[which(ComIUCN$IUCNstatus == "Least Concern")] <- "Green"
ComIUCN$iucn_colour[which(ComIUCN$IUCNstatus == "Not Assessed")] <- "Blue"
```

## analysis

```{r}
IUCNVGVG<- as_data_frame(ComIUCN) %>%
  select(lambda, generation_time, IUCNstatus) %>% 
  mutate(across(c(lambda, generation_time), ~ na_if(., Inf))) %>% 
  mutate(across(c(lambda, generation_time), ~ na_if(., -Inf))) %>%
  drop_na()
```

generation time

```{r}

IUCNVGT <- boxplot(IUCNVGVG, IUCNVGVG$IUCNstatus, "IUCN status", IUCNVGVG$generation_time, "Generation Time (years)", "")
IUCNVGT

ANOVAGT <- aov(generation_time ~ IUCNstatus, data = IUCNVGVG)
summary(ANOVAGT)
```

Growth Rate

```{r}
IUCNVL <- boxplot(IUCNVGVG, IUCNVGVG$IUCNstatus, "IUCN status", IUCNVGVG$lambda, "Growth Rate (位)", "")
IUCNVL

ANOVALambda <- aov(lambda ~ IUCNstatus, data = IUCNVGVG)
summary(ANOVALambda)
```

-   

# open tree of life
